<!DOCTYPE html>
<html lang="en">
<head>

  <meta charset="UTF-8" />
  <title>Firebase site hosting | Olivier Patry</title>

  <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Lato:300,300italic">
  <link rel="stylesheet" type="text/css" href="/assets/styles.css">
  <link rel="stylesheet" type="text/css" href="/assets/highlighting/thankful_eyes.css">
  <link rel="shortcut icon" href="/favicon.ico">

  <meta name=viewport content="width=device-width">

  <!-- Android Chrome 39+ theme color -->
  <meta name="theme-color" content="#3498db">

  <link rel="alternate" type="application/rss+xml" title="RSS" href="/rss.xml">

</head>

<body>
<div class="site">
  <header class="title">
    <p>üè† <a href="/">Back to home</a></p>
  </header>

  <div class="content">
  <article>
    <header>
    <h1>Firebase site hosting</h1>
    </header>

    <section>
<p>I used to host this website on a cheap FTP server and <a href="/2014/04/11/automated-web-site-deployment/">deploy it using <code>lftp</code></a>.
It seems now a bit archaic, I use Firebase to host it these days.
Here follows the setup to automatically deploy the website using hosted Continuous Integration services such as BitBucket or GitLab Pipelines.</p>

<h2 id="local-setup">Local setup</h2>

<p>First, you‚Äôll need to setup your local work environment by installing Firebase tools:</p>

<div class="code-container">
<div class="langspec">Bash</div>
<pre class="highlight"><code class="language-bash"><span class="nv">$ </span>npm <span class="nb">install</span> <span class="nt">-g</span> firebase-tools</code></pre>
</div>
<p>Then, login to your Google account using <code>firebase login</code>.</p>

<p>To map your local work tree to a Firebase project, execute <code>firebase init</code> and select <code>Hosting</code>. You‚Äôll be asked to choose 
or create a Firebase project.</p>

<p>Once done, <code>.firebaserc</code> and <code>firebase.json</code> files will be created. The former defines the Firebase project and the latter
defines some configuration for your project structure, like the directory to publish.
For a <a href="https://nanoc.ws/"><code>nanoc</code></a> website you‚Äôll use <code>output</code>:</p>

<div class="code-container">
<div class="langspec">Json</div>
<pre class="highlight"><code class="language-json"><span class="p">{</span><span class="w">
  </span><span class="nl">"hosting"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"public"</span><span class="p">:</span><span class="w"> </span><span class="s2">"output"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
<p>Finally, deploy your local output online using <code>firebase deploy</code>.</p>

<h2 id="continuous-integration-setup">Continuous Integration setup</h2>

<p>You can choose to deploy your site by hand using your local copy but sooner or later, you‚Äôll be better with a
continuous integration build for this purpose.</p>

<p>I share here the BitBucket and GitLab pipelines configurations I used for this website.</p>

<p>There is no big difficulty, the tedious part was the provisioning of the image used to build this site due to
its dependencies (<code>pygmentize</code> for syntax highlighting, Node JS for minifiers and Firebase‚Ä¶).</p>

<p>For any CI, you‚Äôll need to generate a token allowing automated deployment:</p>

<div class="code-container">
<div class="langspec">Bash</div>
<pre class="highlight"><code class="language-bash"><span class="nv">$ </span>firebase login:ci

Visit this URL on any device to log <span class="k">in</span>:
&lt;some long URL to use&gt;

Waiting <span class="k">for </span>authentication...

‚úî  Success! Use this token to login on a CI server:

&lt;CI token to keep as an environment variable&gt;

Example: firebase deploy <span class="nt">--token</span> <span class="s2">"</span><span class="nv">$FIREBASE_TOKEN</span><span class="s2">"</span></code></pre>
</div>
<!-- title broken after ``` ``` block, needed something (like this comment!) to fix it -->

<h3 id="bitbucket">BitBucket</h3>

<p>To use <a href="https://bitbucket.org/product/features/pipelines">BitBucket pipelines</a>, create a <code>bitbucket-pipelines.yml</code> file:</p>

<div class="code-container">
<div class="langspec">Yaml</div>
<pre class="highlight"><code class="language-yaml"><span class="na">image</span><span class="pi">:</span> <span class="s">ruby:2.4.0</span>

<span class="na">pipelines</span><span class="pi">:</span>
  <span class="na">branches</span><span class="pi">:</span>
    <span class="na">master</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">step</span><span class="pi">:</span>
        <span class="na">caches</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s">npm</span>
          <span class="pi">-</span> <span class="s">bundler</span>
        <span class="na">script</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s">curl -sL https://deb.nodesource.com/setup_8.x | bash -</span>
          <span class="pi">-</span> <span class="s">apt-get update -qq &amp;&amp; apt-get install -y nodejs python-pygments locales</span>
          <span class="pi">-</span> <span class="s">echo "en_US UTF-8" &gt; /etc/locale.gen</span>
          <span class="pi">-</span> <span class="s">locale-gen en_US.UTF-8</span>
          <span class="pi">-</span> <span class="s">export LANG=en_US.UTF-8</span>
          <span class="pi">-</span> <span class="s">export LANGUAGE=en_US:en</span>
          <span class="pi">-</span> <span class="s">export LC_ALL=en_US.UTF-8</span>
          <span class="pi">-</span> <span class="s">npm install --prefix .npm firebase-tools</span>
          <span class="pi">-</span> <span class="s">bundle install --path=.bundler</span>
          <span class="pi">-</span> <span class="s">bundle exec nanoc compile</span>
          <span class="pi">-</span> <span class="s">bundle exec nanoc check ilinks elinks css stale</span>
          <span class="pi">-</span> <span class="s">.npm/node_modules/firebase-tools/bin/firebase deploy -m "BitBucket build#$BITBUCKET_BUILD_NUMBER" --token "$FIREBASE_TOKEN" --non-interactive</span>

  <span class="na">custom</span><span class="pi">:</span>
    <span class="na">check</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">step</span><span class="pi">:</span>
          <span class="na">caches</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s">bundler</span>
          <span class="na">script</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s">curl -sL https://deb.nodesource.com/setup_8.x | bash -</span>
            <span class="pi">-</span> <span class="s">apt-get update -qq &amp;&amp; apt-get install -y nodejs python-pygments locales</span>
            <span class="pi">-</span> <span class="s">echo "en_US UTF-8" &gt; /etc/locale.gen</span>
            <span class="pi">-</span> <span class="s">locale-gen en_US.UTF-8</span>
            <span class="pi">-</span> <span class="s">export LANG=en_US.UTF-8</span>
            <span class="pi">-</span> <span class="s">export LANGUAGE=en_US:en</span>
            <span class="pi">-</span> <span class="s">export LC_ALL=en_US.UTF-8</span>
            <span class="pi">-</span> <span class="s">bundle install --path=.bundler</span>
            <span class="pi">-</span> <span class="s">bundle exec nanoc compile</span>
            <span class="pi">-</span> <span class="s">bundle exec nanoc check ilinks elinks css stale</span>

<span class="na">definitions</span><span class="pi">:</span>
  <span class="na">caches</span><span class="pi">:</span>
    <span class="na">bundler</span><span class="pi">:</span> <span class="s">.bundler</span>
    <span class="na">npm</span><span class="pi">:</span> <span class="s">.npm</span></code></pre>
</div>
<p>As you might have noticed, I used a <code>FIREBASE_TOKEN</code> environment variable, go to <code>Settings &gt; Pipelines / Environment Variables</code>.
Add a new <em>secured</em> environment variable <code>FIREBASE_TOKEN</code> with the value returned by <code>firebase login:ci</code>.</p>

<p>In this setup, I publish only on <code>master</code> branch but allow build from any other branch to validate it without deploying.</p>

<h3 id="gitlab">GitLab</h3>

<p>The <a href="https://docs.gitlab.com/ee/ci/pipelines.html">GitLab pipeline</a> setup is similar, create a <code>.gitlab-ci.yml</code> file:</p>

<div class="code-container">
<div class="langspec">Yaml</div>
<pre class="highlight"><code class="language-yaml"><span class="na">image</span><span class="pi">:</span> <span class="s2">"</span><span class="s">ruby:2.4"</span>

<span class="na">cache</span><span class="pi">:</span>
  <span class="na">paths</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">.npm</span>
  <span class="pi">-</span> <span class="s">.bundler</span>

<span class="na">before_script</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">curl -sL https://deb.nodesource.com/setup_8.x | bash -</span>
  <span class="pi">-</span> <span class="s">apt-get update -qq &amp;&amp; apt-get install -y nodejs python-pygments locales</span>
  <span class="pi">-</span> <span class="s">echo "en_US UTF-8" &gt; /etc/locale.gen</span>
  <span class="pi">-</span> <span class="s">locale-gen en_US.UTF-8</span>
  <span class="pi">-</span> <span class="s">export LANG=en_US.UTF-8</span>
  <span class="pi">-</span> <span class="s">export LANGUAGE=en_US:en</span>
  <span class="pi">-</span> <span class="s">export LC_ALL=en_US.UTF-8</span>
  <span class="pi">-</span> <span class="s">gem install bundler --no-ri --no-rdoc</span>
  <span class="pi">-</span> <span class="s">bundle install --path=.bundler --jobs $(nproc)</span>

<span class="na">compile</span><span class="pi">:</span>
  <span class="na">stage</span><span class="pi">:</span> <span class="s">build</span>
  <span class="na">script</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">bundle exec nanoc compile</span>
  <span class="na">artifacts</span><span class="pi">:</span>
    <span class="na">paths</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">output/</span>

<span class="na">check</span><span class="pi">:</span>
  <span class="na">stage</span><span class="pi">:</span> <span class="s">test</span>
  <span class="na">script</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">bundle exec nanoc check ilinks elinks css stale</span>

<span class="na">deploy</span><span class="pi">:</span>
  <span class="na">stage</span><span class="pi">:</span> <span class="s">deploy</span>
  <span class="na">script</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">npm install --prefix .npm firebase-tools</span>
    <span class="pi">-</span> <span class="s">.npm/node_modules/firebase-tools/bin/firebase deploy -m "GitLab Pipeline#$CI_PIPELINE_ID Build#$CI_BUILD_ID" --token "$FIREBASE_TOKEN" --non-interactive</span>
  <span class="na">only</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">master</span></code></pre>
</div>
<p>This time, the <code>FIREBASE_TOKEN</code> variable should be created from <code>Settings &gt; CI/CD &gt; Secret Variables</code>.</p>

<p>The <code>deploy</code> Job is only available on <code>master</code> branch, this way, you can have build validation on any branch but continuous deployment only on <code>master</code>.</p>

<p>I had troubles with UTF-8 encoding, <a href="https://gitlab.com/gitlab-org/gitlab-foss/-/issues/14983#note_4637913">needed <code>en_US.UTF-8</code> locale installation and configuration</a>.</p>

<hr>

<p>You can also refer to the <a href="https://firebase.google.com/docs/cli/">Firebase command line documentation</a>.</p>

<p>The initial source of this <em>How To</em> comes from <a href="https://chris.banes.dev/jekyll-firebase/">Chris Banes</a>. 
Chris Banes‚Äôs article provides CI setup for Circle CI.</p>

    </section>

    <footer>
    <p class="metatada">Originally published on November 25, 2017.</p>

    <hr>

    <p id="navlinks" class="navinfos">
    <a class="prev" title="BitBucket Pipelines for Android" href="/2017/11/06/bitbucket-pipelines-for-android/">&#9666;&nbsp;BitBucket Pipelines for Android</a>
    <span>| <a href="/">üè†</a> |</span>
    <span class="disabled">&nbsp;&#9657;</span>
    </p>
    </footer>
  </article>
  </div>

</div>
</body>
</html>
